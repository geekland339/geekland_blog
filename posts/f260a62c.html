<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>docker自动化部署 | GeekLand极客</title><meta name="author" content="GeekLand极客"><meta name="copyright" content="GeekLand极客"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文章主要记录一下如何实现项目的自动化集成部署，并且让docker容器支持HTTPS的访问，并且通过几个例子来实践。这也是我目前觉得服务端比较好的架构思路了   解决哪些痛点问题在个人开发项目的时候，我们希望自己写的项目网站能放到有公网IP的服务器上供每个人都可以浏览访问，但是服务器端通常会遇到一些问题： 端口问题： 比如A项目需要占用3000端口，B项目也需要，这个时候导致端口的冲突，就需要修改端">
<meta property="og:type" content="article">
<meta property="og:title" content="docker自动化部署">
<meta property="og:url" content="http://geekland.top/posts/f260a62c.html">
<meta property="og:site_name" content="GeekLand极客">
<meta property="og:description" content="文章主要记录一下如何实现项目的自动化集成部署，并且让docker容器支持HTTPS的访问，并且通过几个例子来实践。这也是我目前觉得服务端比较好的架构思路了   解决哪些痛点问题在个人开发项目的时候，我们希望自己写的项目网站能放到有公网IP的服务器上供每个人都可以浏览访问，但是服务器端通常会遇到一些问题： 端口问题： 比如A项目需要占用3000端口，B项目也需要，这个时候导致端口的冲突，就需要修改端">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imgapi.mitsumune.top/?2948">
<meta property="article:published_time" content="2025-05-18T06:37:54.000Z">
<meta property="article:modified_time" content="2025-05-19T06:10:26.508Z">
<meta property="article:author" content="GeekLand极客">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imgapi.mitsumune.top/?2948"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://geekland.top/posts/f260a62c.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'docker自动化部署',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-19 14:10:26'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/logo.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://imgapi.mitsumune.top?2948')"><nav id="nav"><span id="blog-info"><a href="/" title="GeekLand极客"><span class="site-name">GeekLand极客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">docker自动化部署</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-18T06:37:54.000Z" title="发表于 2025-05-18 14:37:54">2025-05-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-19T06:10:26.508Z" title="更新于 2025-05-19 14:10:26">2025-05-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="docker自动化部署"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note blue no-icon flat"><p>文章主要记录一下如何实现项目的自动化集成部署，并且让docker容器支持<code>HTTPS</code>的访问，并且通过几个例子来实践。这也是我目前觉得服务端比较好的架构思路了</p>
</div>

<h1 id="解决哪些痛点问题"><a href="#解决哪些痛点问题" class="headerlink" title="解决哪些痛点问题"></a>解决哪些痛点问题</h1><div class="note red no-icon flat"><p>在个人开发项目的时候，我们希望自己写的项目网站能放到有公网<code>IP</code>的服务器上供每个人都可以浏览访问，但是服务器端通常会遇到一些问题：</p>
<p><strong>端口问题：</strong></p>
<p>比如A项目需要占用3000端口，B项目也需要，这个时候导致端口的冲突，就需要修改端口。而且记住端口也是一件很麻烦的事情，容易导致端口冲突问题。（本文只需要服务器开放80和443端口，通过ngixn代理其他docker容器，从而无需开启其他端口就可以访问到容器应用）</p>
<p><strong>部署问题：</strong></p>
<p>每次项目代码的小改动，都需要重新本地构建，连接服务器上传代码，这是非常麻烦的一件事情。（通过Jenkins自动化集成部署可以解决该问题）</p>
<p><strong><code>HTTPS</code>证书问题：</strong></p>
<p>每个项目需要域名访问，比如<code>api.admin.com</code>对应的是<code>api</code>接口项目，<code>front.admin.com</code>对应前端项目，但是证书需要为每个域名单独申请，这就很费时费力了，而且每个证书都有时效性的，过期就需要手动更新，很麻烦（通过<code>acme</code>可以自动更新证书，并且是免费开源的）</p>
<p><strong>碎片化:</strong></p>
<p>服务器端存放的会比较碎片化，安装的软件会比较杂，容易导致软件之间的冲突，比如服务器安装的node环境是14，其中一个项目只能在<code>node14</code>才可以正常运行，另外一个则需要在<code>node20</code>环境才可以，或者一个项目放在微信云服务上，另外一个存放在某静态存放网站，这样有可能导致跨域问题，域名也无法统一。（使用一台服务器，利用<code>Docker</code>的隔离性恰好可以解决这个问题）</p>
<p>以上这些痛点问题，本文会搭建一个在服务端持续集成持续部署的环境，并使用<code>Nginx</code>代理支持<code>https</code>的访问。</p>
</div>

<h1 id="服务端整体的架构与思路"><a href="#服务端整体的架构与思路" class="headerlink" title="服务端整体的架构与思路"></a>服务端整体的架构与思路</h1><div class="note blue no-icon flat"><p>在开始搭建之前，有必要先看一下服务端整体的架构图，了解一下在干什么，为什么要这么做，这么做的目的是什么：</p>
</div>

<p><img src="https://img.geekland.top/img/202406302138165.png"></p>
<div class="note purple no-icon flat"><p>先来看下流程：</p>
<ul>
<li>用户通过<code>www.example.com</code>、<code>api.example.com</code>或者<code>blog.example.com</code>等二级域名访问服务</li>
<li><code>DNS</code>服务器（DNSpro、cloudflare）解析这个网址到指定服务器的<code>IP</code>地址上的80端口</li>
<li><code>Nginx</code>接收到这个请求，通过<code>conf</code>配置文件，在内网里面找到这个Docker容器服务，并访问这个Docker容器（这个过程中，<code>Nginx</code>已经通过配置文件给链接加上<code>https</code>证书加密）</li>
<li><code>Docker</code>容器返回给<code>Nginx</code>，<code>Nginx</code>再通过443端口返回给用户。</li>
</ul>
</div>

<div class="note orange no-icon flat"><p>在整个过程中，服务器只是开放80和443端口，Docker容器无需对外开放端口，Docker容器之间通过内网段通讯，互不干扰</p>
</div>

<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><div class="note purple no-icon flat"><p>在开始之前，我们需要准备一下环境：</p>
<ul>
<li>一台初始化的<code>centos7.8</code>系统服务器（避免软件安装冲突）</li>
<li>一个已经备案的域名（国内服务器域名需要备案）</li>
</ul>
</div>

<h1 id="服务器连接配置"><a href="#服务器连接配置" class="headerlink" title="服务器连接配置"></a>服务器连接配置</h1><h2 id="修改默认端口："><a href="#修改默认端口：" class="headerlink" title="修改默认端口："></a>修改默认端口：</h2><p>连接服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@you ip</span><br></pre></td></tr></table></figure>

<p>修改端口，编辑<code>sshd_config</code>文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>

<p>输入 i 编辑，把#去掉，把22改为想要的端口，最后:wq保存：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 10024</span><br></pre></td></tr></table></figure>

<p>然后需要执行这一句命令：（端口是刚才修改的端口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port -a -t ssh_port_t -p tcp 10024</span><br></pre></td></tr></table></figure>

<p>可能会得到一个错误，可以执行一下下面这句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum whatprovides semanage</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y  policycoreutils-python</span><br></pre></td></tr></table></figure>

<p>最后再重新执行：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port <span class="literal">-a</span> <span class="literal">-t</span> ssh_port_t <span class="literal">-p</span> tcp <span class="number">10024</span></span><br></pre></td></tr></table></figure>

<p>查看<code>SSH</code>运行的端口：（不是必须执行）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port -l | grep ssh</span><br></pre></td></tr></table></figure>

<p>删除<code>SSH</code>端口：（不是必须执行）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port -d -t ssh_port_t -p tcp 22 </span><br></pre></td></tr></table></figure>

<p>重启<code>SSH</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>

<p>重新连接服务器：（端口是刚才的端口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 10024 root@your ip</span><br></pre></td></tr></table></figure>

<h2 id="密钥方式连接服务器："><a href="#密钥方式连接服务器：" class="headerlink" title="密钥方式连接服务器："></a>密钥方式连接服务器：</h2><p>在本地电脑生成SSH Key，一直回车就可以：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br></pre></td></tr></table></figure>

<p>在本地路径C:\Users\你的用户\.ssh下创建<code>config</code>文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host Test</span><br><span class="line">    Port #端口号</span><br><span class="line">    HostName #IP地址</span><br><span class="line">    User root</span><br><span class="line">    IdentityFile #本地id_rsa文件</span><br><span class="line">    IdentitiesOnly yes</span><br></pre></td></tr></table></figure>

<p>服务器<code>cd ~/.ssh/</code>目录，（一定要CD到这个目录，切勿直接在根目录直接使用下面命令，会导致这个文件不生效）编辑文件，到本地C:\Users\你的用户名\.ssh 找到公钥文件，把本地电脑的公钥文件<code>id_rsa.pub</code>复制进去，<code>:wq</code>保存：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi authorized_keys</span><br></pre></td></tr></table></figure>

<p>如果之前连接过服务器，格式化后再连接可能报错，可以先删除本地电脑这两个文件，这两个文件是历史连接的记录</p>
<p><img src="https://img.geekland.top/img/202406302146329.png"></p>
<p>至此，完成服务器的端口修改和使用密钥登录的操作</p>
<h1 id="旧版安装docker"><a href="#旧版安装docker" class="headerlink" title="旧版安装docker"></a>旧版安装docker</h1><p>这个办法<strong>适合境外服务器操作</strong>，因为2024年6月初的时候，<code>Docker</code>的镜像无法正常<code>pull</code>了，所以按照这个办法会出现报错等问题，不推荐；（有新版的安装方式下面介绍）</p>
<p>该内容步骤具体可以参考：<a target="_blank" rel="noopener" href="https://www.toimc.com/docker%E5%85%A5%E9%97%A8%E4%B9%8B%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/">https://www.toimc.com/docker%E5%85%A5%E9%97%A8%E4%B9%8B%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/</a> </p>
<ol>
<li><p>先删除旧的版本(如果没有可以跳过)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装必须的依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure>

<p>添加<code>stable</code>的Docker-ce的源：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>docker-ce</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br></pre></td></tr></table></figure></li>
</ol>
<p>docker-compose安装：</p>
<p>Docker-Compose工具是一个<code>批量</code>工具，用于运行与管理多个<code>docker</code>容器。官方文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/">Install Docker Compose</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载docker-compose</span></span><br><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给予执行权限</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试命令</span></span><br><span class="line">docker-compose --version</span><br><span class="line">docker-compose version 1.23.2, build 1110ad01</span><br></pre></td></tr></table></figure>

<h1 id="新版安装docker"><a href="#新版安装docker" class="headerlink" title="新版安装docker"></a>新版安装docker</h1><p>由于不可抗力原因，截至目前，2024年6月27号，阿里云的服务器是无法正常拉取docker镜像的，以下是阿里云售后技术的回复：</p>
<blockquote>
<p>您好，近期因为<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a>  被污染（具体可以参考：<a target="_blank" rel="noopener" href="https://boce.aliyun.com/home?spm=5176.smartservice_service_robot_chat_new.0.0.59b13f1b8XYWoe">https://boce.aliyun.com/home</a>） timeout等现象， 关于解决方案 </p>
<p>1、针对个人单docker环境客户 </p>
<p>1.1 本地先pull下来（因为域名被污染，本地可能也无法拉取，可以考虑中国香港或者是海外的服务器pull下来）</p>
<p>1.2 使用docker save导出为<code>tar.gz</code>文件，然后上传到自己的机器，使用<code>docker load -i XXX.tar.gz</code>解压出来使用 导出命令： <code>docker save -o nginx.tar.gz nginx:latest</code> 导入命令： <code>docker load -i nginx.tar.gz</code> </p>
<p>2、针对集群用户 </p>
<p>2.1 本地先pull下来（因为域名被污染，本地可能也无法拉取，可以考虑中国香港或者是海外的服务器pull下来） </p>
<p>2.2 修改tag 命令（例如）： <code>docker tag nginx:latest ceshi:latest 2.3</code> 然后上传到阿里云<code>acr</code> 容器镜像仓库里面，<code>yaml</code>地址里面修改为您阿里云仓库的<code>vpc</code>地址，用私网拉取，比走海外公网的速率高以及稳定性强一点 注意：如果您的集群或者是<code>ACR</code>是大陆的，可能会存在链路问题导致镜像推送到<code>ACR</code>失败，建议导出镜像后导入镜像到您本地的大陆机器，然后<code>push</code>到您的<code>ACR</code>里边</p>
</blockquote>
<p>所以现在安装<code>Docker</code>如果按照之前的方式会出现无法正常安装的情况，<code>Docker</code>也无法正常的<code>pull</code>镜像，这里有两种解决方法：（当然方法不止这两种）</p>
<ol>
<li>使用境外的服务器，把镜像<code>pull</code>到本地，然后再上传到服务器，优点是简单粗暴，原理简单。缺点是要下载镜像有限，只能先下载需要用到的镜像。（我采用的是这种方式）</li>
<li>使用<code>cloudflare</code>和这个开源项目<a target="_blank" rel="noopener" href="https://github.com/cmliu/CF-Workers-docker.io/issues/8">https://github.com/cmliu/CF-Workers-docker.io/issues/8</a> ，原理就是使用<code>cloudflare</code>去代理<code>dockerhub</code>这个网站，这样就可以访问到<code>dockerhub</code>。配置起来很简单，具体可以看看这个UP主，讲解得比较简单明了：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1H442197oQ/">https://www.bilibili.com/video/BV1H442197oQ/</a></li>
</ol>
<p>这里是<code>centos7.8</code>的安装步骤：</p>
<ol>
<li><p>运行以下命令，下载<code>docker-ce</code>的<code>yum</code>源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行以下命令，安装Docker。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install docker-ce</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行以下命令，检查Docker是否安装成功。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>如下图回显信息所示，表示Docker已安装成功。</p>
<p><img src="https://img.geekland.top/img/202406302157798.png"></p>
</li>
<li><p>执行以下命令，启动Docker服务，并设置开机自启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker </span><br><span class="line">sudo systemctl enable docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行以下命令，查看Docker是否启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status docker</span><br></pre></td></tr></table></figure></li>
</ol>
<p>安装docker-compose：（<code>centos7.8</code>不推荐使用，在一些场景会报错，推荐适用老版本的安装方式）</p>
<ol>
<li><p>运行以下命令，安装<code>setuptools</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install -U pip setuptools</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行以下命令，安装<code>docker-compose</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行以下命令，验证<code>docker-compose</code>是否安装成功。（这里会提示一个警告，可以忽略，大概意思就是python版本太低，）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></li>
</ol>
<p>docker的安装具体参考阿里云：<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/ecs/use-cases/install-and-use-docker-on-a-linux-ecs-instance">https://help.aliyun.com/zh/ecs/use-cases/install-and-use-docker-on-a-linux-ecs-instance</a></p>
<h1 id="安装acme"><a href="#安装acme" class="headerlink" title="安装acme"></a>安装acme</h1><p>acme官网<code>Github</code>：<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh">https://github.com/acmesh-official/acme.sh</a></p>
<p>首先确认您域名使用的<code>DNS</code>服务商，不同的<code>DNS</code>服务商对应的命令是不同的。比如这里使用的腾讯云的<code>DNSPro</code>解析域名服务。</p>
<p>安装：（这里一定要带上自己的邮箱，否则后面会报错，会有记录报错，需要多试几次）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh -s email=&quot;xxxx@qq.com&quot;</span><br></pre></td></tr></table></figure>

<p>这个命令安装acme并且创建了一个 <code>cronjob</code>, 每天 <code>0:00</code> 点自动检测所有的证书, 如果快过期了, 需要更新, 则会自动更新证书.</p>
<blockquote>
<p>注意：<strong>安装好之后建议重新连接服务期</strong>，如果这个时候直接使用<code>acme.sh</code>可能有问题</p>
</blockquote>
<h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><p>下面是示例的讲解：</p>
<p>生成证书：（这里我们使用<code>DNSAPi</code>的高阶用法生成证书）</p>
<p>更高阶的用法：<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/How-to-issue-a-cert">https://github.com/acmesh-official/acme.sh/wiki/How-to-issue-a-cert</a></p>
<p><code>DNS APi</code>：<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">https://github.com/acmesh-official/acme.sh/wiki/dnsapi</a></p>
<p>以下是<code>cloudflare</code>的生成证书方式：（<code>cloudflare</code>的<code>DNS</code>有个坑，后面介绍）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export CF_Key=&quot;sdfsdfsdfljlbjkljlkjsdfoiwje&quot;</span><br><span class="line">export CF_Email=&quot;xxxx@qq.com&quot;</span><br><span class="line">acme.sh --issue --dns dns_cf -d example.com -d  *.example.com</span><br></pre></td></tr></table></figure>

<p>以下是<code>DNSPro</code>的生成证书方式：(注意申请的是<code>DNSPro</code>的令牌不是腾讯云的令牌)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export DP_Id=&quot;XXXX&quot;</span><br><span class="line">export DP_Key=&quot;XXXXXXXXXXXXX&quot;</span><br><span class="line">acme.sh --issue --dns dns_dp -d example.top -d *.example.top</span><br></pre></td></tr></table></figure>

<p>至此，证书签发完成。</p>
<h1 id="安装Nginx容器"><a href="#安装Nginx容器" class="headerlink" title="安装Nginx容器"></a>安装<code>Nginx</code>容器</h1><h2 id="流程梳理"><a href="#流程梳理" class="headerlink" title="流程梳理"></a>流程梳理</h2><div class="note purple no-icon flat"><ol>
<li>创建<code>home/keys</code>文件夹，存放<code>Https</code>证书文件</li>
<li>创建随机的密钥</li>
<li>创建容器的局域网段https</li>
<li>创建<code>/home/keys/nginx/conf.d</code>文件夹,存放<code>nginx</code>的配置文件</li>
<li>创建<code>nginx.conf</code>文件,并上传到服务器<code>home/nginx</code>文件夹下</li>
<li>通过<code>docker-cpmpose</code>文件安装<code>Nginx</code></li>
<li>最后执行<code>acme.sh</code>命令</li>
</ol>
</div>

<blockquote>
<p>Tip：把所有的配置文件都放在home文件夹下，方便以后管理，目录使用英文并具有一定意义</p>
</blockquote>
<h2 id="Https文件存放"><a href="#Https文件存放" class="headerlink" title="Https文件存放"></a>Https文件存放</h2><p>按照上面的流程，我们需要把<code>https</code>证书放到一个可以让<code>nginx</code>容器访问到的地方，这是一个官方的示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d example.top \</span><br><span class="line">--key-file       /path/to/keyfile/in/nginx/key.pem  \</span><br><span class="line">--fullchain-file /path/to/fullchain/nginx/cert.pem \</span><br><span class="line">--reloadcmd     <span class="string">&quot;service nginx force-reload&quot;</span></span><br></pre></td></tr></table></figure>

<p>(一个小提醒, 这里用的是 <code>service nginx force-reload</code>, 不是 <code>service nginx reload</code>, 据测试, <code>reload</code> 并不会重新加载证书, 所以用的 <code>force-reload</code>)</p>
<p>因为我们使用的是<code>Docker</code>的方式安装<code>Nginx</code>，所以我们需要修改一下，把目录都放到<code>home</code>目录的<code>key</code>文件夹下（记得域名改为自己的）</p>
<p>创建文件夹：<code>mkdir /home/keys</code>，存放<code>Https</code>证书文件，这一步只需要创建文件夹，无需执行命令，最后再执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d example.top \</span><br><span class="line">--key-file       /home/keys/key.pem  \</span><br><span class="line">--fullchain-file /home/keys/cert.pem \</span><br><span class="line">--reloadcmd     <span class="string">&quot;docker restart some-nginx&quot;</span></span><br></pre></td></tr></table></figure>

<p>这句命令主要为域名创建了两个证书文件，并放在key指定文件夹下，最后重启<code>some-nginx</code>容器</p>
<h2 id="创建随机的密钥"><a href="#创建随机的密钥" class="headerlink" title="创建随机的密钥"></a>创建随机的密钥</h2><ul>
<li><p>创建随机的<code>https</code>证书密钥：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dhparam -out /home/keys/dhparam.pem 2048</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="创建容器的局域网段"><a href="#创建容器的局域网段" class="headerlink" title="创建容器的局域网段"></a>创建容器的局域网段</h2><p>创建容器的局域网段https：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建容器的局域网段https</span></span><br><span class="line">docker network create https</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这是查询network有哪些网段</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这是查询network里面https网段里面有哪些容器加入进来</span></span><br><span class="line">docker network inspect https</span><br></pre></td></tr></table></figure>

<h2 id="nginx的配置文件存放"><a href="#nginx的配置文件存放" class="headerlink" title="nginx的配置文件存放"></a><code>nginx</code>的配置文件存放</h2><ul>
<li><p>创建文件夹：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/nginx</span><br><span class="line">mkdir /home/nginx/conf.d</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="创建nginx-conf文件"><a href="#创建nginx-conf文件" class="headerlink" title="创建nginx.conf文件"></a>创建<code>nginx.conf</code>文件</h2><ul>
<li><p>创建<code>nginx.conf</code>文件,并上传到服务器<code>home/nginx</code>文件夹下，这是一个通用的文件配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65535</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="comment"># 设置事件驱动模型，是内核2.6以上支持</span></span><br><span class="line">  <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">65535</span>;</span><br><span class="line">  <span class="attribute">accept_mutex</span> <span class="literal">off</span>;</span><br><span class="line">  <span class="attribute">multi_accept</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="comment"># Basic Settings</span></span><br><span class="line">  <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">send_timeout</span> <span class="number">120</span>;</span><br><span class="line">  <span class="attribute">keepalive_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">client_body_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">client_header_timeout</span> <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">proxy_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">proxy_send_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="comment">#tcp_nopush on;</span></span><br><span class="line">  <span class="attribute">types_hash_max_size</span> <span class="number">4096</span>;</span><br><span class="line">  <span class="attribute">client_header_buffer_size</span> <span class="number">16m</span>;</span><br><span class="line">  <span class="attribute">client_max_body_size</span> <span class="number">4096m</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">  <span class="comment"># include /usr/share/nginx/modules/*.conf;</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">  <span class="comment"># Logging Settings</span></span><br><span class="line">  <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line">  <span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line">  <span class="attribute">log_format</span> main <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">  <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">  <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line">  <span class="comment"># 开启gzip</span></span><br><span class="line">  <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment"># 启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line">  <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">  <span class="comment"># gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明</span></span><br><span class="line">  <span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line">  <span class="comment"># 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span></span><br><span class="line">  <span class="attribute">gzip_types</span> text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml;</span><br><span class="line">  <span class="comment"># 是否在http header中添加Vary: Accept-Encoding，建议开启</span></span><br><span class="line">  <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment"># 禁用IE 6 gzip</span></span><br><span class="line">  <span class="attribute">gzip_disable</span> <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装<code>Nginx</code></h2><ul>
<li>接下来是<code>Nginx</code>容器安装，编写<code>docker-compose</code>文件：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;some-nginx&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/nginx/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/keys:/home/keys</span></span><br><span class="line">      <span class="comment"># blog</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/blog:/var/www</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker network create https</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解释：创建了一个<code>some-nginx</code>的容器，把容器文件<code>nginx.conf</code>、<code>conf.d</code>和keys文件夹挂载出来。暴露端口是80和443；把容器加入到<code>https</code>的网段里面，让这个网段里面的容器可以被<code>nginx</code>容器代理到。</p>
<p>编写好后就可以直接使用一下命令安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2 id="执行acme-sh命令"><a href="#执行acme-sh命令" class="headerlink" title="执行acme.sh命令"></a>执行<code>acme.sh</code>命令</h2><p>最后我们就可以运行之前<code>acem</code>的安装命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d example.top \</span><br><span class="line">--key-file       /home/keys/key.pem  \</span><br><span class="line">--fullchain-file /home/keys/cert.pem \</span><br><span class="line">--reloadcmd     &quot;docker resatrt some-nginx&quot;</span><br></pre></td></tr></table></figure>

<p>正常的话，这里运行着一个<code>nginx</code>容器了，这里的步骤稍微复杂但是细心一点还是没有难度的，特别需要注意的是域名、文件夹和文件名这些内容不要写错。</p>
<p>截止到这里，基本已经完成基本的架构，只需要其他docker容器加入到https这个网段内，通过conf文件，让nginx这个容器可以访问到就可以了。</p>
<blockquote>
<p>TIP：这里在使用<code>docker-compos</code>安装前，需要把<code>Nginx</code>的文件夹先创建好，给目录777权限，<code>nginx.conf</code>是文件，<code>conf.d</code>是文件夹</p>
</blockquote>
<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h2 id="静态博客站简单部署"><a href="#静态博客站简单部署" class="headerlink" title="静态博客站简单部署"></a>静态博客站简单部署</h2><p><code>cd</code>到&#x2F;<code>home/nginx/conf.d</code>目录，然后编写文件<code>blog.conf</code>文件，然后放到<code>home</code>目录的<code>nginx</code>的<code>conf.d</code>文件夹下（记得替换域名）</p>
<p><code>blog.conf</code>文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># listen on HTTP2/SSL</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">  <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">  <span class="comment"># ssl certs from letsencrypt</span></span><br><span class="line">  <span class="comment"># ssl on;</span></span><br><span class="line">  <span class="attribute">ssl_certificate</span> /home/keys/cert.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /home/keys/key.pem;</span><br><span class="line">  <span class="comment"># dhparam.pem</span></span><br><span class="line">  <span class="attribute">ssl_dhparam</span> /home/keys/dhparam.pem;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">50m</span>;</span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">30m</span>;</span><br><span class="line">  <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">  <span class="comment"># ciphers chosen for forward secrecy and compatibility</span></span><br><span class="line">  <span class="comment"># http://blog.ivanristic.com/2013/08/configuring-apache-nginx-and-openssl-for-forward-secrecy.html</span></span><br><span class="line">  <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubdomains; preload&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># redirect HTTP and handle let&#x27;s encrypt requests</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在home目录下的<code>blog</code>放静态资源，然后<code>DNS</code>服务商把<code>www</code>网站解析到服务器即可以访问</p>
<h2 id="安装Jenkins"><a href="#安装Jenkins" class="headerlink" title="安装Jenkins"></a>安装Jenkins</h2><p>使用docker-compose方式安装：</p>
<p>创建一个名字叫<code>docker-compose.yml</code>的文件:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">jenkins/jenkins:lts</span></span><br><span class="line">   <span class="attr">volumes:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">/home/jenkins/data/:/var/jenkins_home</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/usr/bin/docker:/usr/bin/docker</span></span><br><span class="line">   <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;50000:5000&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;10051:10051&quot;</span>    </span><br><span class="line">   <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">   <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建了一个<code>jenkins</code>的最新版本镜像，并创建运行一个叫<code>jenkins</code>容器端口可以挂载也可以不挂载，因为使用的是域名访问，没有影响。</p>
</blockquote>
<p>需要给文件夹赋予权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 /home/jenkins/data</span><br></pre></td></tr></table></figure>

<p>这里我们可以使用<code>ftp</code>工具上传到服务器上的<code>home</code>目录下的<code>jenkins</code>，推荐使用<code>FileZilla Client</code>。</p>
<p>然后<code>cd</code>到docker-compose的目录下，使用一下命令安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>安装好之后我们需要得到一串密钥文件，输入命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs  -f jenkins</span><br></pre></td></tr></table></figure>

<p>可以得到一个密钥，等会安装需要，可以先记录下来，不先安装，先让<code>nginx</code>能代理<code>jenkins</code>容器再来安装。同样的操作的：</p>
<p><code>jenkins.conf</code>文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> target-server &#123;</span><br><span class="line">  <span class="attribute">server</span> jenkins:<span class="number">8080</span> fail_timeout=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># listen on HTTP2/SSL</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">  <span class="attribute">server_name</span> jenkins.example.top;</span><br><span class="line">  <span class="comment"># ssl certs from letsencrypt</span></span><br><span class="line">  <span class="attribute">ssl_certificate</span> /home/keys/cert.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /home/keys/key.pem;</span><br><span class="line">  <span class="comment"># dhparam.pem</span></span><br><span class="line">  <span class="attribute">ssl_dhparam</span> /home/keys/dhparam.pem;</span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">  <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&#x27;</span>;</span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Ssl <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://target-server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># redirect HTTP and handle let&#x27;s encrypt requests</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> jenkins.example.top;</span><br><span class="line">  <span class="comment"># send everything else to HTTPS</span></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">302</span> https://jenkins.example.top;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://target-server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意容器是<code>8080</code>端口的，域名改为自己的。target-server这个根据个人修改，每个应用不能重复</p>
<p>接下来就是打开域名，访问Jenkins，把刚才的密钥复制粘贴，安装插件，创建用户</p>
<p>然后需要Jenkins下载下面3个插件：</p>
<ul>
<li>Build With Parameters 输入框式的参数</li>
<li>Persistent Parameter  下拉框式的参数</li>
<li><code>Gitee</code></li>
</ul>
<p>最后再配置<code>Gitee</code>的用户名密码，能然后的项目部署访问到。</p>
<p>补充：这里后面涉及到项目需要在<code>jengkins</code>使用<code>docker-compos</code>的命令，这里写一下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">进入 Jenkins 容器</span><br><span class="line">docker exec -it jenkins_container_name bash</span><br><span class="line">安装 Docker Compose</span><br><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"> 添加执行权限</span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p><code>jenkins_container_name</code>是自己<code>jenkins</code>的容器名称。</p>
<h2 id="安装Halo"><a href="#安装Halo" class="headerlink" title="安装Halo"></a>安装Halo</h2><p>由于小型的服务器可能承受不住Halo和mysql的压力，这里演示的是H2数据库：</p>
<p>这是官方提供的docker-compose文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">halo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.fit2cloud.com/halo/halo:2.17</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure:3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./halo2:/root/.halo2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8090/actuator/health/readiness&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">30s</span>          </span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="comment"># 外部访问地址，请根据实际需要修改</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--halo.external-url=http://localhost:8090/</span></span><br></pre></td></tr></table></figure>

<p>但是我们安装这个文件安装，可能就会报错，版本原因（start_period是有版本限制的），这里我们需要优化调整一下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">halo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.fit2cloud.com/halo/halo:2.17.2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure:3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">test</span>  <span class="comment">#容器名称</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">https:</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/halo2/halo2:/root/.halo2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8090/actuator/health/readiness&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span>          </span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="comment"># 外部访问地址，请根据实际需要修改</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--halo.external-url=https://test.test.top</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br></pre></td></tr></table></figure>

<p>增加了container_name（自定义容器名称，方便接下来的Nginx容器访问），剔除了start_period（主要报错原因，版本问题），增加了networks（加入https网段，和Nginx容器同个网段，可以相互之间通讯访问）</p>
<p>安装好Halo容器，最后就需要使用Nginx来代理这个容器，我们可以编写一个conf文件，存放到home&#x2F;nginx&#x2F;conf.d目录下，这样就可以使Nginx容器代理Halo容器了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">upstream halo-server &#123;</span><br><span class="line">  server test:8090 fail_timeout=0;</span><br><span class="line">&#125;</span><br><span class="line"># listen on HTTP2/SSL</span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  server_name test.test.top;</span><br><span class="line"></span><br><span class="line">  # ssl certs from letsencrypt</span><br><span class="line">  ssl_certificate /home/keys/cert.pem;</span><br><span class="line">  ssl_certificate_key /home/keys/key.pem;</span><br><span class="line">  # dhparam.pem</span><br><span class="line">  ssl_dhparam /home/keys/dhparam.pem;</span><br><span class="line">  ssl_session_timeout 5m;</span><br><span class="line">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">  ssl_ciphers &#x27;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&#x27;;</span><br><span class="line">  ssl_prefer_server_ciphers on;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_set_header X-Forwarded-Ssl on;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_set_header Host $host:$server_port;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    proxy_pass http://land-server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># redirect HTTP and handle let&#x27;s encrypt requests</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name test.test.top;</span><br><span class="line">  # send everything else to HTTPS</span><br><span class="line">  location / &#123;</span><br><span class="line">    return 302 https://test.test.top;</span><br><span class="line">    proxy_set_header Host $host:$server_port;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    proxy_pass http://halo-server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要修改地方：</p>
<ul>
<li>proxy_pass <a target="_blank" rel="noopener" href="http://halo-server/">http://halo-server</a> 是 和 halo-server对应的</li>
<li>return 302 <a target="_blank" rel="noopener" href="https://test.test.top/">https://test.test.top</a> 填写自己的域名</li>
<li>server_name test.test.top; 填写自己的域名</li>
<li>server test:8090 fail_timeout&#x3D;0; 填写自己容器名称</li>
</ul>
<h2 id="自动化部署Hexo博客"><a href="#自动化部署Hexo博客" class="headerlink" title="自动化部署Hexo博客"></a>自动化部署Hexo博客</h2><p><code>hexo</code>上传代码需要以下插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>需要改动<code>hexo</code>配置文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">yougitproject</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>上传git代码还需要配置ssh的密钥，同时还需要配置本地的账户名和邮箱</p>
<p>本地生成SSH密钥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br></pre></td></tr></table></figure>

<p>配置git本地的账户名和邮箱</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;Git用户名&quot; </span><br><span class="line">git config --global user.email &quot;Git邮箱&quot;</span><br></pre></td></tr></table></figure>

<p><strong>本地编写<code>DockerFile</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">20</span> as build-stage</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=LSF</span></span><br><span class="line"><span class="comment"># 创建一个工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN npm install --registry=https://registry.npm.taobao.org</span></span><br><span class="line"><span class="comment"># RUN npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx:stable-alpine as production-stage</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build-stage /app /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><strong><code>gitee</code>和<code>jenkins</code>联调</strong></p>
<ol>
<li>创建一个自由风格的项目；</li>
<li>然后选择参数化构建过程，有4个参数，分别是写container_name、port、image_name、tag，类型写String；</li>
<li>源码管理Git填写代码仓库地址。（注意要配置好Gitee的凭据）；</li>
<li>勾选<code>Gitee webhook</code> 触发构建，生成<code>Gitee WebHooks</code> 密码，然后在·仓库的·那里填写这个url和密码，其他可以保持默认；</li>
<li>最后构建过程选择执行shell。</li>
</ol>
<p>shell脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">CONTAINER=$&#123;container_name&#125;</span><br><span class="line">PORT=$&#123;port&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">build docker image</span></span><br><span class="line">docker build --no-cache -t $&#123;image_name&#125;:$&#123;tag&#125; .</span><br><span class="line"></span><br><span class="line">checkDocker() &#123;</span><br><span class="line">  RUNNING=$(docker inspect --format=&quot;&#123;&#123; .State.Running &#125;&#125;&quot; $CONTAINER 2&gt;/dev/null)</span><br><span class="line">  if [ -z $RUNNING ]; then</span><br><span class="line">    echo &quot;$CONTAINER does not exist.&quot;</span><br><span class="line">    return 1</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ &quot;$RUNNING&quot; == &quot;false&quot; ]; then</span><br><span class="line">    matching=$(docker ps -a --filter=&quot;name=$CONTAINER&quot; -q | xargs)</span><br><span class="line">    if [ -n $matching ]; then</span><br><span class="line">      docker rm $matching</span><br><span class="line">    fi</span><br><span class="line">    return 2</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$CONTAINER is running.&quot;</span><br><span class="line">    matchingStarted=$(docker ps --filter=&quot;name=$CONTAINER&quot; -q | xargs)</span><br><span class="line">    if [ -n $matchingStarted ]; then</span><br><span class="line">      docker stop $matchingStarted</span><br><span class="line">      docker rm $&#123;container_name&#125;</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkDocker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">run docker image</span></span><br><span class="line">docker run -it d --name $CONTAINER -p $PORT:80 $&#123;image_name&#125;:$&#123;tag&#125;</span><br></pre></td></tr></table></figure>

<p>这样基本就搭建完成，本店只要通过<code>hexo g</code>命令上传代码，<code>jenkins</code>就可以自动构建部署了，因为没有使用docker-compose文件所以这里需要shell脚本，后面使用docker-compose就不需要这么复杂的shell脚本</p>
<p><code>nginx</code>的配置文件与<code>jenkins</code>一样，需要修改域名，target-server和注意容器的端口</p>
<h2 id="自动化部署Vue前端项目"><a href="#自动化部署Vue前端项目" class="headerlink" title="自动化部署Vue前端项目"></a>自动化部署Vue前端项目</h2><p><strong>项目根目录本地编写<code>DockerFile</code>和<code>docker-compose</code>文件</strong></p>
<p><code>DockerFile</code>文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">20</span> as build-stage</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=Tech</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install --registry=https://registry.npmmirror.com --legacy-peer-deps</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx:stable-alpine as production-stage</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build-stage /app/dist /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><code>docker-compose</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">Version:</span> <span class="number">1.0</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vueprojrctimg:1.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">vueprojrct</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10000</span><span class="string">:80</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br></pre></td></tr></table></figure>

<p><strong><code>gitee</code>和<code>jenkins</code>联调</strong></p>
<p>与自动化部署Hexo博客一样，但是去除掉参数化和改shell脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">docker-compose up --build</span><br></pre></td></tr></table></figure>

<p><code>nginx</code>的配置文件与<code>jenkins</code>一样，需要修改域名，target-server和注意容器的端口</p>
<h2 id="自动化部署NodeJS项目"><a href="#自动化部署NodeJS项目" class="headerlink" title="自动化部署NodeJS项目"></a>自动化部署NodeJS项目</h2><p><strong>本地编写<code>DockerFile</code>和<code>docker-compose</code>文件</strong></p>
<p><strong>项目根目录本地编写<code>DockerFile</code>和<code>docker-compose</code>文件</strong></p>
<p><code>DockerFile</code>文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">20</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=Tech</span></span><br><span class="line"><span class="comment"># 创建一个工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install --registry=https://registry.npmmirror.com --legacy-peer-deps</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">12006</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [ <span class="string">&quot;/app/public&quot;</span> ] <span class="comment">#不一定挂载出来</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;node&quot;</span>, <span class="string">&quot;dist/bundle.js&quot;</span> ]</span></span><br></pre></td></tr></table></figure>

<p><code>docker-compose</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">Version:</span> <span class="number">1.0</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nodeprojrctimg:1.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nodeprojrct</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10001</span><span class="string">:3000</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br></pre></td></tr></table></figure>

<p><strong><code>gitee</code>和<code>jenkins</code>联调</strong></p>
<p>与自动化部署Hexo博客一样，但是去除掉参数化和改shell脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">docker-compose up --build</span><br></pre></td></tr></table></figure>

<p><code>nginx</code>的配置文件与<code>jenkins</code>一样，需要修改域名，target-server和注意容器的端口</p>
<h1 id="可能用到的工具"><a href="#可能用到的工具" class="headerlink" title="可能用到的工具"></a>可能用到的工具</h1><p>这里列举了我常用的开发工具和连接服务器工具链接</p>
<ul>
<li>VsCode:<a target="_blank" rel="noopener" href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></li>
<li>Git:<a target="_blank" rel="noopener" href="https://git-scm.com/">https://git-scm.com/</a></li>
<li>PicGo:<a target="_blank" rel="noopener" href="https://picgo.github.io/PicGo-Doc/zh/">https://picgo.github.io/PicGo-Doc/zh/</a></li>
<li>Snipaste:<a target="_blank" rel="noopener" href="https://zh.snipaste.com/">https://zh.snipaste.com/</a></li>
<li>FileZilla Client: <a target="_blank" rel="noopener" href="https://www.filezilla.cn/">https://www.filezilla.cn/</a></li>
</ul>
<h1 id="一些踩过的坑！！"><a href="#一些踩过的坑！！" class="headerlink" title="一些踩过的坑！！"></a>一些踩过的坑！！</h1><p>在部署的时候遇到一个巨坑，因为使用的是<code>cloudflare</code>进行·解析，但是有一个断到断的加密过程，看下面图片就知道了，用户访问会被<code>cloudflare</code>先代理，走<code>https</code>，但是<code>cloudflare</code>跟服务器也要走<code>https</code>，不能走<code>http</code>，不然就会出现前端重定向问题！这里一般选择完全的<code>SSL</code>加密</p>
<p><img src="https://img.geekland.top//img/202407051650059.png"></p>
<p>如果是使用cloudflare代理的网站，在安装halo后可能会遇到插件和应用商店看不到的问题，这需要在cloudflare后台缓存-&gt;配置-&gt;缓存级别改为标准，这也是一个巨坑！</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>服务器端密钥登录</p>
</li>
<li><p>Docker和<code>DockerCompose</code>的安装</p>
</li>
<li><p>acme的安装过程</p>
</li>
<li><p><code>Nginx</code>安装和acme的配置</p>
</li>
<li><p>不同的方式安装docker容器项目，实现自动化部署集成并支持<code>https</code>访问</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://geekland.top">GeekLand极客</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://geekland.top/posts/f260a62c.html">http://geekland.top/posts/f260a62c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://geekland.top" target="_blank">GeekLand极客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/docker/">docker</a></div><div class="post_share"><div class="social-share" data-image="https://imgapi.mitsumune.top?2948" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/950bd4e5.html" title="docker自动化部署新版"><img class="cover" src="https://imgapi.mitsumune.top?697" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">docker自动化部署新版</div></div></a></div><div class="next-post pull-right"><a href="/posts/b00f8cd6.html" title="Vue基础入门"><img class="cover" src="https://imgapi.mitsumune.top?6733" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Vue基础入门</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/logo.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">GeekLand极客</div><div class="author-info__description">路虽远行则将至，事虽难做则必成</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/geekland339"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/geekland339" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这是我个人的博客日志</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%93%AA%E4%BA%9B%E7%97%9B%E7%82%B9%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">解决哪些痛点问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%95%B4%E4%BD%93%E7%9A%84%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">服务端整体的架构与思路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">3.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">服务器连接配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">修改默认端口：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E6%96%B9%E5%BC%8F%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%9A"><span class="toc-number">4.2.</span> <span class="toc-text">密钥方式连接服务器：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A7%E7%89%88%E5%AE%89%E8%A3%85docker"><span class="toc-number">5.</span> <span class="toc-text">旧版安装docker</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B0%E7%89%88%E5%AE%89%E8%A3%85docker"><span class="toc-number">6.</span> <span class="toc-text">新版安装docker</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85acme"><span class="toc-number">7.</span> <span class="toc-text">安装acme</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">7.1.</span> <span class="toc-text">生成证书</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Nginx%E5%AE%B9%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">安装Nginx容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-number">8.1.</span> <span class="toc-text">流程梳理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Https%E6%96%87%E4%BB%B6%E5%AD%98%E6%94%BE"><span class="toc-number">8.2.</span> <span class="toc-text">Https文件存放</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%9A%8F%E6%9C%BA%E7%9A%84%E5%AF%86%E9%92%A5"><span class="toc-number">8.3.</span> <span class="toc-text">创建随机的密钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E7%9A%84%E5%B1%80%E5%9F%9F%E7%BD%91%E6%AE%B5"><span class="toc-number">8.4.</span> <span class="toc-text">创建容器的局域网段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AD%98%E6%94%BE"><span class="toc-number">8.5.</span> <span class="toc-text">nginx的配置文件存放</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAnginx-conf%E6%96%87%E4%BB%B6"><span class="toc-number">8.6.</span> <span class="toc-text">创建nginx.conf文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Nginx"><span class="toc-number">8.7.</span> <span class="toc-text">安装Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cacme-sh%E5%91%BD%E4%BB%A4"><span class="toc-number">8.8.</span> <span class="toc-text">执行acme.sh命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">9.</span> <span class="toc-text">最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2%E7%AB%99%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2"><span class="toc-number">9.1.</span> <span class="toc-text">静态博客站简单部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Jenkins"><span class="toc-number">9.2.</span> <span class="toc-text">安装Jenkins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Halo"><span class="toc-number">9.3.</span> <span class="toc-text">安装Halo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2Hexo%E5%8D%9A%E5%AE%A2"><span class="toc-number">9.4.</span> <span class="toc-text">自动化部署Hexo博客</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2Vue%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">9.5.</span> <span class="toc-text">自动化部署Vue前端项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2NodeJS%E9%A1%B9%E7%9B%AE"><span class="toc-number">9.6.</span> <span class="toc-text">自动化部署NodeJS项目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E7%94%A8%E5%88%B0%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">10.</span> <span class="toc-text">可能用到的工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91%EF%BC%81%EF%BC%81"><span class="toc-number">11.</span> <span class="toc-text">一些踩过的坑！！</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">12.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/950bd4e5.html" title="docker自动化部署新版"><img src="https://imgapi.mitsumune.top?697" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="docker自动化部署新版"/></a><div class="content"><a class="title" href="/posts/950bd4e5.html" title="docker自动化部署新版">docker自动化部署新版</a><time datetime="2025-05-19T10:46:55.000Z" title="发表于 2025-05-19 18:46:55">2025-05-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f260a62c.html" title="docker自动化部署"><img src="https://imgapi.mitsumune.top?2948" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="docker自动化部署"/></a><div class="content"><a class="title" href="/posts/f260a62c.html" title="docker自动化部署">docker自动化部署</a><time datetime="2025-05-18T06:37:54.000Z" title="发表于 2025-05-18 14:37:54">2025-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b00f8cd6.html" title="Vue基础入门"><img src="https://imgapi.mitsumune.top?6733" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue基础入门"/></a><div class="content"><a class="title" href="/posts/b00f8cd6.html" title="Vue基础入门">Vue基础入门</a><time datetime="2025-05-10T08:16:50.000Z" title="发表于 2025-05-10 16:16:50">2025-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e2e81a90.html" title="百度收录 Cloudflare Page 显示 308 报错"><img src="https://imgapi.mitsumune.top?8397" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="百度收录 Cloudflare Page 显示 308 报错"/></a><div class="content"><a class="title" href="/posts/e2e81a90.html" title="百度收录 Cloudflare Page 显示 308 报错">百度收录 Cloudflare Page 显示 308 报错</a><time datetime="2025-05-09T11:29:57.000Z" title="发表于 2025-05-09 19:29:57">2025-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e2f41d03.html" title="杂记1"><img src="https://imgapi.mitsumune.top?5555" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="杂记1"/></a><div class="content"><a class="title" href="/posts/e2f41d03.html" title="杂记1">杂记1</a><time datetime="2025-05-09T02:22:46.000Z" title="发表于 2025-05-09 10:22:46">2025-05-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By GeekLand极客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'w6Gw4UqYW4lsKyVlK45T98xo-gzGzoHsz',
      appKey: '9hvrOAKzIWScQU8OSxWiO5L0',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !true) {
    if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>